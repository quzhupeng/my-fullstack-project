# 产销分析系统需求文档

## 1. 项目背景与目标

当前系统使用Python处理Excel生成静态HTML页面，实现了核心的数据展示功能。然而，该方案存在部署流程繁琐、缺乏用户交互、扩展性差等问题。

本项目旨在将现有系统重构为一个基于Cloudflare Pages, Workers, 和 D1的现代化、可交互的全栈应用。

**核心目标:**

*   **动态交互:** 用户能够通过Web界面进行交互式的数据探索，如按需筛选日期范围、切换分析维度等。
*   **自动化部署:** 改变原先手动部署的流程，实现自动化、无缝的开发和部署体验。
*   **高性能:** 借助Cloudflare边缘计算，实现全球高性能访问。
*   **低运维成本:** 采用无服务器（Serverless）模型，将运维工作降至最低。
*   **可扩展性:** 构建一个健壮、可扩展的系统，为未来增加更复杂的数据分析功能（如EOQ、需求价格弹性分析、销量预测等）奠定基础。

## 2. 功能需求

### 2.1. 数据模型需求

*   系统需支持以下核心业务实体：
    *   **产品 (Products):** 存储所有唯一的产品信息，包括产品ID、名称、SKU、分类等。
    *   **每日指标 (DailyMetrics):** 记录每个产品在特定日期的产量、销量、库存和价格。
*   数据库需要通过规范化设计，减少数据冗余，提升数据一致性和完整性。
*   需要为高频查询字段（如日期、产品ID）建立索引，以优化查询性能。

### 2.2. 数据导入需求

*   **批量导入:** 支持通过离线脚本（如Python）将历史Excel数据批量导入到D1数据库。该脚本需要处理数据清洗、转换和关系映射。
*   **在线上传:** 支持授权用户通过前端界面上传新的Excel文件，后端Worker自动解析文件内容并将其存入数据库，实现数据的自动化更新。

### 2.3. 后端API需求

*   需提供一套RESTful API，为前端提供数据支持。
*   API需要支持通过查询参数（如 `start_date`, `end_date`, `limit`）进行数据的筛选和聚合。
*   所有数据聚合运算（如求和、平均值）应在数据库层面完成，以保证API性能。
*   API需具备健壮的错误处理和输入验证机制。

### 2.4. 前端与用户界面需求

*   **数据可视化:**
    *   核心指标摘要：展示产品总数、时间跨度、总销量等关键聚合指标。
    *   库存量TopN产品图：以柱状图展示指定日期库存量最高的产品。
    *   每日综合产销率趋势图：以面积图展示产销率的时间序列变化。
    *   每日销售量与平均单价趋势图：以双Y轴图展示销量和价格的关联趋势。
*   **交互功能:**
    *   提供日期范围选择器，用户可以选择任意时间段来筛选和分析数据。
    *   所有图表和数据应根据用户的筛选条件动态更新，并提供流畅的交互体验（如加载状态提示、平滑的图表重绘动画）。
*   **数据管理:**
    *   提供文件上传界面，用于在线更新数据。

## 3. 非功能性需求

*   **性能:** 页面加载和数据查询响应需快速，目标是核心查询在1秒内返回。
*   **安全性:** 后端API需防止SQL注入等常见安全漏洞。数据上传功能需进行权限控制。
*   **可维护性:** 代码需遵循最佳实践，例如后端API使用类型安全的Hono框架，前后端代码分离，数据库结构通过`schema.sql`文件进行版本管理。
*   **部署:** 整个应用（前端和后端）需能通过Cloudflare Pages和Wrangler CLI进行一键部署。
