# æ˜¥é›ªé£Ÿå“äº§é”€åˆ†æç³»ç»Ÿ - å¼€å‘æ³¨æ„äº‹é¡¹

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº†åœ¨å¼€å‘å’Œç»´æŠ¤æ˜¥é›ªé£Ÿå“äº§é”€åˆ†æç³»ç»Ÿè¿‡ç¨‹ä¸­å‘ç°çš„å…³é”®å®ç°ç»†èŠ‚ã€å¸¸è§é™·é˜±å’Œé‡è¦è­¦å‘Šï¼Œæ—¨åœ¨å¸®åŠ©æœªæ¥çš„å¼€å‘è€…é¿å…é‡å¤é—®é¢˜å¹¶å¿«é€Ÿç†è§£ç³»ç»Ÿæ¶æ„ã€‚

**æœ€åæ›´æ–°**: 2025å¹´6æœˆ30æ—¥
**ç‰ˆæœ¬**: v2.0 (åŒ…å«ç”Ÿäº§éƒ¨ç½²ç»éªŒ)
**çŠ¶æ€**: âœ… åŸºäºå®é™…é¡¹ç›®ç»éªŒéªŒè¯

## ğŸš¨ 1.1 æœ€å…³é”®é—®é¢˜ - æ•°æ®æ˜¾ç¤ºé—®é¢˜

### é—®é¢˜æè¿°
**ç—‡çŠ¶**: å‰ç«¯æ‰€æœ‰æ•°æ®æ˜¾ç¤ºä¸º"--"ï¼Œå›¾è¡¨ç©ºç™½ï¼ŒAPIè¿”å›ç©ºæ•°ç»„ `[]`
**å½±å“**: ç³»ç»ŸåŠŸèƒ½å®Œå…¨ä¸å¯ç”¨ï¼Œä¸šåŠ¡ä»·å€¼æ— æ³•å®ç°
**å‘ç”Ÿæ¦‚ç‡**: æé«˜ (æ•°æ®å¯¼å…¥åçš„å¿…ç°é—®é¢˜)

### æ ¹æœ¬åŸå› 
APIè¿‡æ»¤æ¡ä»¶è¿‡ä¸¥ï¼Œ`p.category IS NOT NULL AND p.category != ''` è¿‡æ»¤æ‰äº†æ‰€æœ‰äº§å“ï¼Œå› ä¸ºProductsè¡¨ä¸­çš„categoryå­—æ®µéƒ½æ˜¯NULLæˆ–ç©ºå­—ç¬¦ä¸²ã€‚

### å®Œæ•´è§£å†³æ–¹æ¡ˆ
ä¿®æ”¹ `backend/src/index.ts` ä¸­çš„3ä¸ªAPIç«¯ç‚¹ï¼š

```typescript
// ğŸš¨ é—®é¢˜ä»£ç  (ä¼šå¯¼è‡´è¿”å›ç©ºæ•°ç»„)
AND (
  p.category IS NOT NULL
  AND p.category != ''
  AND p.category NOT IN ('å‰¯äº§å“', 'ç”Ÿé²œå“å…¶ä»–')
)

// âœ… ä¿®å¤ä»£ç  (å…è®¸ç©ºcategoryå­—æ®µ)
AND (
  p.category IS NULL
  OR p.category = ''
  OR p.category NOT IN ('å‰¯äº§å“', 'ç”Ÿé²œå“å…¶ä»–')
)
```

### éœ€è¦ä¿®å¤çš„APIç«¯ç‚¹
1. `/api/inventory/top` (è¡Œ99-104)
2. `/api/trends/ratio` (è¡Œ145-150)
3. `/api/trends/sales-price` (è¡Œ190-195)

### éªŒè¯ä¿®å¤æˆåŠŸ
```bash
# ä¿®å¤å‰æµ‹è¯•
curl "http://localhost:8787/api/inventory/top?date=2025-06-26&limit=5"
# è¿”å›: [] (ç©ºæ•°ç»„ - é—®é¢˜)

# ä¿®å¤åæµ‹è¯•
curl "http://localhost:8787/api/inventory/top?date=2025-06-26&limit=5"
# è¿”å›: [{"product_name":"é¸¡æ’è…¿200/250","inventory_level":318990}...] (æ­£å¸¸)
```

### âš ï¸ é¢„é˜²æªæ–½
1. **æ•°æ®å¯¼å…¥åç«‹å³éªŒè¯**: æ¯æ¬¡å¯¼å…¥æ•°æ®åå¿…é¡»æµ‹è¯•APIå“åº”
2. **å­—æ®µå®Œæ•´æ€§æ£€æŸ¥**: å¯¼å…¥å‰æ£€æŸ¥å…³é”®å­—æ®µçš„NULLå€¼åˆ†å¸ƒ
3. **è¿‡æ»¤æ¡ä»¶è®¾è®¡**: è®¾è®¡è¿‡æ»¤æ¡ä»¶æ—¶è€ƒè™‘å®é™…æ•°æ®çŠ¶æ€ï¼Œé¿å…è¿‡ä¸¥æ¡ä»¶

## 2. æ•°æ®å¯¼å…¥å…³é”®æ³¨æ„äº‹é¡¹

### 2.1 âš ï¸ åº“å­˜æ•°æ®å¤„ç†çš„é‡è¦å‘ç°

**é—®é¢˜**: åº“å­˜Excelæ–‡ä»¶(`æ”¶å‘å­˜æ±‡æ€»è¡¨æŸ¥è¯¢.xlsx`)é€šå¸¸ä¸åŒ…å«æ—¥æœŸåˆ—ï¼Œå¯¼è‡´æ‰€æœ‰åº“å­˜æ•°æ®è¢«åˆ†é…åˆ°åŒä¸€ä¸ªæ—¥æœŸã€‚

**è§£å†³æ–¹æ¡ˆ**: 
```python
# åœ¨data_importer.pyä¸­å®ç°å¤šæ—¥æœŸåº“å­˜è®°å½•ç”Ÿæˆ
if 'record_date' not in df.columns:
    print(f"ğŸ”§ FIXING: Creating inventory records for multiple dates...")
    date_range = pd.date_range(start='2025-06-01', end='2025-06-26', freq='D')
    
    expanded_records = []
    for _, row in df.iterrows():
        for date in date_range:
            new_row = row.copy()
            new_row['record_date'] = date.strftime('%Y-%m-%d')
            expanded_records.append(new_row)
    
    df = pd.DataFrame(expanded_records)
```

**âš ï¸ è­¦å‘Š**: 
- ä¸è¦ç›´æ¥ä½¿ç”¨æ–‡ä»¶ä¿®æ”¹æ—¶é—´ä½œä¸ºåº“å­˜æ—¥æœŸ
- ç¡®ä¿åº“å­˜æ•°æ®è¦†ç›–å®Œæ•´çš„åˆ†æå‘¨æœŸ
- åº“å­˜æ•°æ®åº”è¯¥æ˜¯æœŸæœ«ä½™é¢ï¼Œä¸éœ€è¦æŒ‰æ—¥ç´¯åŠ 

### 2.2 âš ï¸ ä»·æ ¼æ•°æ®åˆ—åæ˜ å°„

**é—®é¢˜**: Excelæ–‡ä»¶ä¸­çš„ä»·æ ¼åˆ—åå¯èƒ½æœ‰å¤šç§å˜ä½“ã€‚

**è§£å†³æ–¹æ¡ˆ**: å®ç°ä¼˜å…ˆçº§æ˜ å°„
```python
# æŒ‰ä¼˜å…ˆçº§å°è¯•ä¸åŒçš„ä»·æ ¼åˆ—å
if 'æœ¬å¸å«ç¨å•ä»·' in df.columns:
    df.rename(columns={'æœ¬å¸å«ç¨å•ä»·': 'average_price'}, inplace=True)
elif 'å«ç¨å•ä»·' in df.columns:
    df.rename(columns={'å«ç¨å•ä»·': 'average_price'}, inplace=True)
elif 'æœ¬å¸æ— ç¨å•ä»·' in df.columns and 'æœ¬å¸æ— ç¨é‡‘é¢' in df.columns:
    # è®¡ç®—å«ç¨ä»·æ ¼: (æ— ç¨é‡‘é¢ / ä¸»æ•°é‡) * 1.09
    df['average_price'] = (df['æœ¬å¸æ— ç¨é‡‘é¢'] / df['sales_volume']) * 1.09
```

**âš ï¸ è­¦å‘Š**:
- ä»·æ ¼è®¡ç®—æ—¶è¦å¤„ç†é™¤é›¶é”™è¯¯
- ç¡®ä¿ä»·æ ¼å•ä½ä¸€è‡´(å…ƒ/å¨)
- éªŒè¯è®¡ç®—å‡ºçš„ä»·æ ¼æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…

### 2.3 âš ï¸ äº§å“åç§°ä¸€è‡´æ€§

**å…³é”®è¦æ±‚**: æ‰€æœ‰Excelæ–‡ä»¶ä¸­çš„äº§å“åç§°å¿…é¡»å®Œå…¨ä¸€è‡´ï¼ŒåŒ…æ‹¬ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦ã€‚

**æ£€æŸ¥æ–¹æ³•**:
```python
# æ£€æŸ¥äº§å“åç§°ä¸€è‡´æ€§
inbound_products = set(inbound_df['product_name'].unique())
sales_products = set(sales_df['product_name'].unique())
summary_products = set(summary_df['product_name'].unique())

print(f"ä»…åœ¨ç”Ÿäº§æ–‡ä»¶ä¸­: {inbound_products - sales_products - summary_products}")
print(f"ä»…åœ¨é”€å”®æ–‡ä»¶ä¸­: {sales_products - inbound_products - summary_products}")
print(f"ä»…åœ¨åº“å­˜æ–‡ä»¶ä¸­: {summary_products - inbound_products - sales_products}")
```

## 3. å‰ç«¯å¼€å‘æ³¨æ„äº‹é¡¹

### 3.1 âš ï¸ è‡ªåŠ¨æ•°æ®åŠ è½½æœºåˆ¶

**é‡è¦å‘ç°**: ç”¨æˆ·ç™»å½•åå¿…é¡»è‡ªåŠ¨åŠ è½½æ‰€æœ‰æ•°æ®ï¼Œä¸èƒ½ä¾èµ–ç”¨æˆ·æ‰‹åŠ¨æ“ä½œã€‚

**å®ç°æ–¹æ¡ˆ**:
```javascript
// åœ¨auth.jsä¸­ï¼Œç™»å½•æˆåŠŸåè°ƒç”¨
if (typeof window.loadAllData === 'function') {
    window.loadAllData();
} else {
    loadSummaryData();
}

// åœ¨script.jsä¸­å®ç°ç»¼åˆæ•°æ®åŠ è½½
window.loadAllData = async function() {
    await loadSummaryData();
    
    if (document.getElementById('start-date') && document.getElementById('end-date')) {
        const startDate = document.getElementById('start-date').value || '2025-06-01';
        const endDate = document.getElementById('end-date').value || '2025-06-26';
        
        await Promise.all([
            updateSummaryCards(startDate, endDate),
            updateInventoryChart(endDate),
            updateSalesPriceChart(startDate, endDate),
            updateRatioTrendChart(startDate, endDate)
        ]);
    }
};
```

### 3.2 âš ï¸ EChartså›¾è¡¨åˆå§‹åŒ–

**é—®é¢˜**: å›¾è¡¨å®¹å™¨å¿…é¡»åœ¨DOMä¸­å­˜åœ¨ä¸”æœ‰å°ºå¯¸æ—¶æ‰èƒ½åˆå§‹åŒ–ã€‚

**è§£å†³æ–¹æ¡ˆ**:
```javascript
function initializeCharts() {
    // ç¡®ä¿å®¹å™¨å­˜åœ¨ä¸”å¯è§
    const inventoryContainer = document.getElementById('inventory-chart');
    if (inventoryContainer && inventoryContainer.offsetWidth > 0) {
        inventoryChart = echarts.init(inventoryContainer);
    }
}

// åœ¨é¡µé¢åˆ‡æ¢æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨å¤§å°
function resizeCharts() {
    if (inventoryChart) inventoryChart.resize();
    if (salesPriceChart) salesPriceChart.resize();
    if (ratioTrendChart) ratioTrendChart.resize();
}
```

### 3.3 âš ï¸ é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ

**æœ€ä½³å®è·µ**:
```javascript
async function fetchWithErrorHandling(url) {
    try {
        showLoading(true);
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('APIè¯·æ±‚å¤±è´¥:', error);
        showErrorMessage(`æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`);
        return null;
    } finally {
        showLoading(false);
    }
}
```

## 4. åç«¯å¼€å‘æ³¨æ„äº‹é¡¹

### 4.1 âš ï¸ CORSé…ç½®

**å¿…éœ€é…ç½®**: æœ¬åœ°å¼€å‘æ—¶å¿…é¡»æ­£ç¡®é…ç½®CORSã€‚

```typescript
// åœ¨index.tsä¸­
app.use('*', cors({
    origin: ['http://localhost:3000', 'http://127.0.0.1:3000'],
    allowMethods: ['GET', 'POST', 'PUT', 'DELETE'],
    allowHeaders: ['Content-Type', 'Authorization'],
}));
```

### 4.2 âš ï¸ æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

**å…³é”®ç´¢å¼•**:
```sql
-- å¿…éœ€çš„ç´¢å¼•ï¼Œæ˜¾è‘—å½±å“æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_dailymetrics_date ON DailyMetrics(record_date);
CREATE INDEX idx_dailymetrics_product_id ON DailyMetrics(product_id);
CREATE INDEX idx_dailymetrics_date_product ON DailyMetrics(record_date, product_id);
```

**æŸ¥è¯¢ä¼˜åŒ–ç¤ºä¾‹**:
```typescript
// é¿å…å…¨è¡¨æ‰«æï¼Œä½¿ç”¨ç´¢å¼•
const query = `
    SELECT record_date, 
           SUM(sales_volume) as sales_volume,
           AVG(average_price) as avg_price
    FROM DailyMetrics 
    WHERE record_date BETWEEN ? AND ? 
      AND sales_volume > 0 
      AND average_price > 0
    GROUP BY record_date 
    ORDER BY record_date
`;
```

### 4.3 âš ï¸ é”™è¯¯å¤„ç†å’Œå‚æ•°éªŒè¯

**å¿…éœ€éªŒè¯**:
```typescript
app.get('/api/summary', async (c) => {
    const startDate = c.req.query('start_date');
    const endDate = c.req.query('end_date');
    
    if (!startDate || !endDate) {
        return c.json({ error: 'Missing required parameters: start_date, end_date' }, 400);
    }
    
    // éªŒè¯æ—¥æœŸæ ¼å¼
    if (!/^\d{4}-\d{2}-\d{2}$/.test(startDate) || !/^\d{4}-\d{2}-\d{2}$/.test(endDate)) {
        return c.json({ error: 'Invalid date format. Use YYYY-MM-DD' }, 400);
    }
    
    try {
        // æ•°æ®åº“æŸ¥è¯¢é€»è¾‘
    } catch (error) {
        console.error('Database query failed:', error);
        return c.json({ error: 'Internal server error' }, 500);
    }
});
```

## 5. æ•°æ®åº“è®¾è®¡æ³¨æ„äº‹é¡¹

### 5.1 âš ï¸ å¤–é”®çº¦æŸ

**é‡è¦**: D1æ•°æ®åº“æ”¯æŒå¤–é”®çº¦æŸï¼Œä½†åœ¨å¤§æ‰¹é‡å¯¼å…¥æ—¶å¯èƒ½å½±å“æ€§èƒ½ã€‚

```sql
-- åœ¨schema.sqlä¸­
CREATE TABLE DailyMetrics (
    record_id INTEGER PRIMARY KEY AUTOINCREMENT,
    record_date TEXT NOT NULL,
    product_id INTEGER NOT NULL,
    production_volume REAL DEFAULT 0,
    sales_volume REAL DEFAULT 0,
    inventory_level REAL DEFAULT 0,
    average_price REAL DEFAULT 0,
    FOREIGN KEY (product_id) REFERENCES Products(product_id)
);
```

### 5.2 âš ï¸ æ•°æ®ç±»å‹é€‰æ‹©

**æœ€ä½³å®è·µ**:
- æ—¥æœŸ: ä½¿ç”¨TEXTç±»å‹å­˜å‚¨'YYYY-MM-DD'æ ¼å¼
- æ•°å€¼: ä½¿ç”¨REALç±»å‹ï¼Œé¿å…INTEGER(ä¼šæˆªæ–­å°æ•°)
- äº§å“åç§°: ä½¿ç”¨TEXTï¼Œç¡®ä¿æ”¯æŒä¸­æ–‡

## 6. æ€§èƒ½ä¼˜åŒ–æ³¨æ„äº‹é¡¹

### 6.1 âš ï¸ å¤§æ•°æ®é‡å¤„ç†

**é—®é¢˜**: å½“æ•°æ®é‡è¶…è¿‡10ä¸‡æ¡æ—¶ï¼ŒæŸ¥è¯¢æ€§èƒ½å¯èƒ½ä¸‹é™ã€‚

**è§£å†³æ–¹æ¡ˆ**:
```typescript
// å®æ–½åˆ†é¡µæŸ¥è¯¢
const BATCH_SIZE = 1000;
const offset = (page - 1) * BATCH_SIZE;

const query = `
    SELECT * FROM DailyMetrics 
    WHERE record_date BETWEEN ? AND ?
    ORDER BY record_date, product_id
    LIMIT ? OFFSET ?
`;
```

### 6.2 âš ï¸ å†…å­˜ä½¿ç”¨ä¼˜åŒ–

**æ³¨æ„äº‹é¡¹**:
- Cloudflare Workersæœ‰128MBå†…å­˜é™åˆ¶
- é¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®åˆ°å†…å­˜
- ä½¿ç”¨æµå¼å¤„ç†å¤„ç†å¤§æ–‡ä»¶

## 7. å®‰å…¨æ³¨æ„äº‹é¡¹

### 7.1 âš ï¸ è®¤è¯ç³»ç»Ÿ

**å½“å‰çŠ¶æ€**: ä½¿ç”¨Mockè®¤è¯ï¼Œä»…é€‚ç”¨äºå¼€å‘ç¯å¢ƒã€‚

**ç”Ÿäº§ç¯å¢ƒè¦æ±‚**:
```typescript
// å®æ–½çœŸå®çš„JWTè®¤è¯
import { sign, verify } from 'hono/jwt';

app.use('/api/*', async (c, next) => {
    const token = c.req.header('Authorization')?.replace('Bearer ', '');
    
    if (!token) {
        return c.json({ error: 'Unauthorized' }, 401);
    }
    
    try {
        const payload = await verify(token, c.env.JWT_SECRET);
        c.set('user', payload);
        await next();
    } catch (error) {
        return c.json({ error: 'Invalid token' }, 401);
    }
});
```

### 7.2 âš ï¸ è¾“å…¥éªŒè¯

**å¿…éœ€éªŒè¯**:
- SQLæ³¨å…¥é˜²æŠ¤
- XSSé˜²æŠ¤
- æ–‡ä»¶ä¸Šä¼ å®‰å…¨æ£€æŸ¥

## 8. éƒ¨ç½²æ³¨æ„äº‹é¡¹

### 8.1 âš ï¸ ç¯å¢ƒå˜é‡ç®¡ç†

**é‡è¦é…ç½®**:
```toml
# wrangler.toml
[vars]
ENVIRONMENT = "production"
API_VERSION = "v1"

[env.production.vars]
JWT_SECRET = "your-secret-key"
```

### 8.2 âš ï¸ æ•°æ®åº“è¿ç§»

**å®‰å…¨æµç¨‹**:
1. å¤‡ä»½ç”Ÿäº§æ•°æ®
2. åœ¨é¢„å‘å¸ƒç¯å¢ƒæµ‹è¯•è¿ç§»
3. æ‰§è¡Œç”Ÿäº§è¿ç§»
4. éªŒè¯æ•°æ®å®Œæ•´æ€§
5. ç›‘æ§ç³»ç»ŸçŠ¶æ€

## 9. ç›‘æ§å’Œè°ƒè¯•

### 9.1 âš ï¸ æ—¥å¿—è®°å½•

**æœ€ä½³å®è·µ**:
```typescript
// ç»“æ„åŒ–æ—¥å¿—è®°å½•
console.log(JSON.stringify({
    timestamp: new Date().toISOString(),
    level: 'INFO',
    message: 'API request processed',
    endpoint: '/api/summary',
    duration: Date.now() - startTime,
    user_id: user?.id
}));
```

### 9.2 âš ï¸ æ€§èƒ½ç›‘æ§

**å…³é”®æŒ‡æ ‡**:
- APIå“åº”æ—¶é—´
- æ•°æ®åº“æŸ¥è¯¢æ—¶é—´
- å†…å­˜ä½¿ç”¨æƒ…å†µ
- é”™è¯¯ç‡ç»Ÿè®¡

## 10. å¸¸è§é™·é˜±å’Œè§£å†³æ–¹æ¡ˆ

### 10.1 æ—¶åŒºé—®é¢˜
- ç¡®ä¿æ‰€æœ‰æ—¥æœŸä½¿ç”¨ç»Ÿä¸€æ—¶åŒº
- åœ¨å‰ç«¯æ˜¾ç¤ºæ—¶è€ƒè™‘ç”¨æˆ·æ—¶åŒº

### 10.2 æ•°æ®ç²¾åº¦é—®é¢˜
- ä½¿ç”¨REALç±»å‹å­˜å‚¨å°æ•°
- å‰ç«¯æ˜¾ç¤ºæ—¶é€‚å½“å››èˆäº”å…¥

### 10.3 ç¼“å­˜ä¸€è‡´æ€§
- æ•°æ®æ›´æ–°ååŠæ—¶æ¸…ç†ç¼“å­˜
- å®æ–½åˆç†çš„ç¼“å­˜è¿‡æœŸç­–ç•¥

---

**é‡è¦æé†’**: æœ¬æ–‡æ¡£åŸºäºå®é™…å¼€å‘ç»éªŒæ€»ç»“ï¼Œå»ºè®®æ–°å¼€å‘è€…åœ¨ä¿®æ”¹ç³»ç»Ÿå‰ä»”ç»†é˜…è¯»ç›¸å…³ç« èŠ‚ï¼Œé¿å…å¼•å…¥å·²çŸ¥é—®é¢˜ã€‚
