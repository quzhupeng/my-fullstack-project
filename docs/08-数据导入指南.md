# 春雪食品产销分析系统 - 数据导入指南

## 1. 概述

本文档详细说明了春雪食品产销分析系统的数据导入流程，包括Excel文件格式要求、列映射关系、常见问题解决方案以及数据质量保证措施。

## 2. Excel文件格式要求

### 2.1 支持的文件类型
- **文件格式**: `.xlsx` (Excel 2007+)
- **文件大小**: 建议不超过50MB
- **编码格式**: UTF-8 (支持中文)

### 2.2 必需的Excel文件

系统需要以下三个Excel文件来完成完整的数据导入：

#### 2.2.1 产成品入库列表 (`产成品入库列表.xlsx`)
**用途**: 生产数据导入
**必需列**:
- `单据日期`: 生产日期 (格式: YYYY-MM-DD 或 Excel日期格式)
- `物料名称`: 产品名称 (必须与其他文件中的产品名称一致)
- `主数量`: 生产数量 (数值类型，单位：吨)

**示例数据**:
```
单据日期        物料名称    主数量
2025-06-01     鸡大胸      10.5
2025-06-01     鸡翅根      8.2
```

#### 2.2.2 收发存汇总表查询 (`收发存汇总表查询.xlsx`)
**用途**: 库存数据导入
**必需列**:
- `物料名称`: 产品名称 (必须与其他文件中的产品名称一致)
- `结存`: 库存余额 (数值类型，单位：吨)

**重要说明**: 
- 此文件通常不包含日期列
- 系统会自动为每个产品创建多个日期的库存记录
- 库存数据会应用到指定的日期范围内

**示例数据**:
```
物料名称    结存
鸡大胸      510.463
鸡翅根      318.990
```

#### 2.2.3 销售发票执行查询 (`销售发票执行查询.xlsx`)
**用途**: 销售和价格数据导入
**必需列**:
- `发票日期`: 销售日期 (格式: YYYY-MM-DD 或 Excel日期格式)
- `物料名称`: 产品名称 (必须与其他文件中的产品名称一致)
- `主数量`: 销售数量 (数值类型，单位：吨)
- `本币含税单价`: 含税单价 (数值类型，单位：元/吨)

**备选价格列** (按优先级排序):
1. `本币含税单价` (首选)
2. `含税单价` (备选)
3. 计算价格: `(本币无税金额 / 主数量) * 1.09` (如果有无税金额数据)

**示例数据**:
```
发票日期        物料名称    主数量    本币含税单价
2025-06-01     鸡大胸      8.5       4.50
2025-06-01     鸡翅根      6.2       4.19
```

## 3. 列映射关系

### 3.1 数据库字段映射

| Excel列名 | 数据库字段 | 数据类型 | 说明 |
|-----------|------------|----------|------|
| `单据日期` | `record_date` | TEXT | 格式化为 YYYY-MM-DD |
| `发票日期` | `record_date` | TEXT | 格式化为 YYYY-MM-DD |
| `物料名称` | `product_name` | TEXT | 产品名称，用于关联产品ID |
| `主数量` (生产) | `production_volume` | REAL | 生产数量，单位：吨 |
| `主数量` (销售) | `sales_volume` | REAL | 销售数量，单位：吨 |
| `结存` | `inventory_level` | REAL | 库存数量，单位：吨 |
| `本币含税单价` | `average_price` | REAL | 平均价格，单位：元/吨 |

### 3.2 数据处理规则

#### 3.2.1 日期处理
- **输入格式**: Excel日期格式或 YYYY-MM-DD 字符串
- **输出格式**: YYYY-MM-DD 字符串
- **无效日期**: 自动跳过包含无效日期的记录

#### 3.2.2 数值处理
- **空值处理**: 空值或非数值自动转换为 0
- **负值处理**: 保留负值（可能表示退货等情况）
- **精度**: 保留小数点后3位

#### 3.2.3 产品名称处理
- **大小写**: 保持原始大小写
- **空格**: 保留前后空格
- **重复**: 自动去重，相同产品名称共享同一个产品ID

## 4. 数据导入流程

### 4.1 准备阶段
1. **文件检查**: 确保三个Excel文件都存在且格式正确
2. **数据验证**: 检查必需列是否存在
3. **备份**: 建议备份现有数据库（如果有）

### 4.2 执行导入

#### 4.2.1 使用Python脚本导入 (推荐)
```bash
# 1. 确保Excel文件在正确位置
ls Excel文件夹/

# 2. 运行数据导入脚本
python3 data_importer.py

# 3. 检查生成的SQL文件
head -20 import_data.sql

# 4. 导入到数据库
cd backend
npx wrangler d1 execute chunxue-prod-db --local --file=../import_data.sql
```

#### 4.2.2 导入过程监控
导入脚本会显示详细的进度信息：
```
🔍 INSPECTING EXCEL FILES...
=== INBOUND FILE: Excel文件夹/产成品入库列表.xlsx ===
Shape: (20840, 15)
Columns: ['单据日期', '物料名称', '主数量', ...]

=== SUMMARY FILE: Excel文件夹/收发存汇总表查询.xlsx ===
Shape: (446, 8)
Columns: ['物料名称', '结存', ...]

=== SALES FILE: Excel文件夹/销售发票执行查询.xlsx ===
Shape: (18349, 12)
Columns: ['发票日期', '物料名称', '主数量', '本币含税单价', ...]

📊 DATA PROCESSING SUMMARY:
✅ Products imported: 704 unique products
✅ Inbound records: 20,840 production records
✅ Sales records: 18,349 sales records  
✅ Inventory records: 11,596 inventory records (across 26 dates)
✅ Final metrics: 9,861 meaningful records (non-zero values)
```

### 4.3 验证阶段
导入完成后，验证数据质量：

```bash
# 检查API端点
curl "http://localhost:8787/api/summary?start_date=2025-06-01&end_date=2025-06-26"
curl "http://localhost:8787/api/inventory/top?date=2025-06-01&limit=5"
curl "http://localhost:8787/api/trends/sales-price?start_date=2025-06-01&end_date=2025-06-05"
```

预期结果：
- 摘要数据显示合理的统计信息
- 库存数据显示非零值
- 价格数据显示实际价格而非零值

## 5. 常见问题与解决方案

### 5.1 数据质量问题

#### 问题1: 库存数据全为零
**症状**: API返回的inventory_level都是0
**原因**: 库存文件缺少日期信息，数据只分配到一个日期
**解决方案**: 
- 使用改进的导入脚本，自动为库存数据创建多日期记录
- 确保查询的日期范围包含库存数据的日期

#### 问题2: 价格数据全为零  
**症状**: API返回的average_price都是0
**原因**: 价格列名不匹配或数据格式错误
**解决方案**:
- 检查Excel文件中的价格列名是否为 `本币含税单价`
- 如果列名不同，修改导入脚本中的列映射
- 检查价格数据是否为数值格式

#### 问题3: 产品名称不匹配
**症状**: 某些产品的数据缺失
**原因**: 不同Excel文件中的产品名称不一致
**解决方案**:
- 统一产品名称的拼写和格式
- 检查是否有多余的空格或特殊字符
- 使用数据清洗工具标准化产品名称

### 5.2 技术问题

#### 问题1: 文件读取失败
**错误信息**: `FileNotFoundError` 或 `Permission denied`
**解决方案**:
- 确保Excel文件路径正确
- 检查文件权限，确保Python脚本可以读取
- 关闭Excel文件（如果正在编辑）

#### 问题2: 内存不足
**错误信息**: `MemoryError` 或处理速度极慢
**解决方案**:
- 分批处理大文件
- 增加系统内存
- 优化数据处理逻辑，减少内存使用

#### 问题3: 数据库导入失败
**错误信息**: SQL语法错误或约束违反
**解决方案**:
- 检查生成的SQL文件语法
- 确保数据库schema是最新的
- 清理现有数据后重新导入

## 6. 数据质量保证

### 6.1 导入前检查清单
- [ ] 三个Excel文件都存在且可读
- [ ] 必需的列都存在且命名正确
- [ ] 日期格式统一且有效
- [ ] 数值列不包含文本内容
- [ ] 产品名称在所有文件中保持一致

### 6.2 导入后验证清单
- [ ] 产品数量符合预期
- [ ] 日期范围覆盖完整
- [ ] 库存数据非零且合理
- [ ] 价格数据非零且合理
- [ ] 生产和销售数据平衡
- [ ] 前端图表正确显示数据

### 6.3 性能监控
- **导入时间**: 通常应在5分钟内完成
- **数据量**: 预期10,000+条有效记录
- **错误率**: 应低于1%
- **API响应**: 查询响应时间应低于500ms

## 7. 维护和更新

### 7.1 定期数据更新
建议每月或每季度更新一次数据：
1. 获取最新的Excel文件
2. 备份现有数据库
3. 运行导入脚本
4. 验证数据质量
5. 更新前端缓存

### 7.2 数据归档
对于历史数据：
- 保留至少2年的详细数据
- 超过2年的数据可以聚合存储
- 定期清理临时文件和日志

### 7.3 监控和告警
设置监控指标：
- 数据导入成功率
- API响应时间
- 数据完整性检查
- 用户访问模式

---

**注意**: 本文档会随着系统更新而持续维护，如遇到文档中未涵盖的问题，请及时更新此文档。
